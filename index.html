<!DOCTYPE html>
<html lang="th" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏≠‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* Light Theme */
            --bg-dark: #f9fafb;      /* gray-50 */
            --bg-med: #ffffff;      /* white */
            --bg-light: #f3f4f6;    /* gray-100 */
            --text-primary: #111827;/* gray-900 */
            --text-secondary: #6b7280;/* gray-500 */
            --border-color: #e5e7eb;/* gray-200 */
            --accent-blue: #3b82f6;
        }
        [data-theme="dark"] {
            --bg-dark: #111827;      /* gray-900 */
            --bg-med: #1f2937;      /* gray-800 */
            --bg-light: #374151;    /* gray-700 */
            --text-primary: #f9fafb;/* gray-50 */
            --text-secondary: #9ca3af;/* gray-400 */
            --border-color: #4b5563;/* gray-600 */
        }
        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-dynamic-med { background-color: var(--bg-med); }
        .bg-dynamic-light { background-color: var(--bg-light); }
        .border-dynamic { border-color: var(--border-color); }
        .text-dynamic-secondary { color: var(--text-secondary); }
        input, textarea, select {
            background-color: var(--bg-light);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { position: relative; aspect-ratio: 1/1; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 50%; transition: background-color 0.2s, border-color 0.2s; }
        .calendar-day.has-data { background-color: #16a34a; color: white; font-weight: 600; }
        .calendar-day.selected { border: 2px solid var(--accent-blue); box-shadow: 0 0 10px var(--accent-blue); }
        .calendar-day.today { background-color: var(--accent-blue); color: white; }
        .shift-icon { position: absolute; bottom: 2px; right: 2px; font-size: 0.6rem; }
        .input-number-control { display: flex; align-items: center; background-color: var(--bg-light); border-radius: 8px; }
        .input-number-control button { width: 40px; height: 40px; background-color: #4b5563; color: white; border: none; font-size: 1.2rem; border-radius: 6px; }
        .input-number-control input { width: 60px; text-align: center; background: transparent; border: none; color: var(--text-primary); -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center;}
        .modal-content { padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; }
        .page { display: block; }
        .page.hidden { display: none; }
        .icon-bar { position: fixed; top: 15px; right: 15px; z-index: 100; display: flex; gap: 12px; }
        .icon-bar svg { width: 24px; height: 24px; cursor: pointer; color: var(--text-secondary); }
        .icon-bar svg:hover { color: var(--text-primary); }
        #sync-indicator { display: none; }
        #sync-indicator svg { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; z-index: 101; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-size: 0.9rem; }
        #toast.show { opacity: 1; bottom: 30px; }
        #toast.success { background-color: #28a745; }
        #toast.error { background-color: #dc3545; }
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="p-2 md:p-4">

    <!-- Icon Bar -->
    <div class="icon-bar">
        <div id="sync-indicator">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </div>
        <div id="theme-toggle-btn">
            <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            <svg id="theme-icon-moon" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
        </div>
        <div id="settings-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </div>
    </div>

    <!-- Main Page -->
    <div id="main-page" class="page max-w-4xl mx-auto">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-4 text-blue-400">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h1>
        
        <div class="bg-dynamic-med p-4 rounded-lg shadow-lg mb-4">
            <div class="flex justify-between items-center mb-3">
                <button id="prev-month" class="px-3 py-1 bg-blue-600 rounded-md hover:bg-blue-700 text-white">&lt;</button>
                <h2 id="month-year" class="text-xl font-semibold"></h2>
                <button id="next-month" class="px-3 py-1 bg-blue-600 rounded-md hover:bg-blue-700 text-white">&gt;</button>
            </div>
            <div class="calendar-grid text-sm mb-2 text-dynamic-secondary">
                <div class="text-center font-bold text-red-400">‡∏≠‡∏≤</div><div class="text-center font-bold">‡∏à</div><div class="text-center font-bold">‡∏≠</div><div class="text-center font-bold">‡∏û</div><div class="text-center font-bold">‡∏û‡∏§</div><div class="text-center font-bold">‡∏®</div><div class="text-center font-bold">‡∏™</div>
            </div>
            <div id="calendar-body" class="calendar-grid"></div>
        </div>

        <div class="bg-dynamic-med p-4 rounded-lg shadow-lg">
            <h3 class="text-lg font-semibold mb-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="selected-date-display" class="text-yellow-400"></span></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <div class="mb-4"><label class="block mb-2 font-medium">‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><div class="flex items-center space-x-4"><label class="flex items-center cursor-pointer"><input type="checkbox" id="shift-day" class="form-checkbox h-5 w-5 text-blue-600 bg-dynamic-light border-dynamic rounded focus:ring-blue-500"><span class="ml-2">‚òÄÔ∏è ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤</span></label><label class="flex items-center cursor-pointer"><input type="checkbox" id="shift-night" class="form-checkbox h-5 w-5 text-indigo-600 bg-dynamic-light border-dynamic rounded focus:ring-indigo-500"><span class="ml-2">üåô ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (+100)</span></label></div></div>
                    <div class="mb-4 p-3 bg-dynamic-light rounded-lg"><h4 class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</h4><p>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á: 372 ‡∏ö‡∏≤‡∏ó</p><p>‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á: 60 ‡∏ö‡∏≤‡∏ó</p><p>‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£: 50 ‡∏ö‡∏≤‡∏ó</p></div>
                    <div id="trip-counters-container" class="space-y-3">
                        <!-- Trip counters will be injected here -->
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
                    <div class="space-y-2">
                        <input type="number" id="ot-before" placeholder="‡∏Ñ‡πà‡∏≤‡πÇ‡∏≠‡∏ó‡∏µ‡∏´‡∏ô‡πâ‡∏≤" class="w-full border rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                        <input type="number" id="other-trips" placeholder="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ" class="w-full border rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                        <textarea id="other-trips-details" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ" rows="2" class="w-full border rounded-md p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <input type="number" id="ot-after" placeholder="‡∏Ñ‡πà‡∏≤‡πÇ‡∏≠‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á" class="w-full border rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                        <input type="number" id="special-food" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©" class="w-full border rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                        <input type="number" id="allowance" placeholder="‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ç‡∏¢‡∏±‡∏ô" class="w-full border rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
            <div class="mt-6 text-center"><h3 class="text-2xl font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="daily-total" class="text-green-400">0</span> ‡∏ö‡∏≤‡∏ó</h3></div>
            <div class="mt-4 grid grid-cols-3 gap-2"><button id="save-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button id="clear-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button><button id="delete-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">‡∏•‡∏ö</button></div>
        </div>
        
        <div class="bg-dynamic-med p-4 rounded-lg shadow-lg mt-4">
            <h3 class="text-xl font-semibold mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</h3><div class="flex justify-center mb-3"><select id="period-selector" class="border rounded-md p-2"><option value="1-15">‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-15</option><option value="16-end">‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 16-‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option></select></div>
            <div id="summary-content" class="text-sm md:text-base grid grid-cols-2 md:grid-cols-3 gap-2"></div>
            <div class="mt-4 text-center"><h3 class="text-xl font-bold">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="period-total" class="text-green-400">0</span> ‡∏ö‡∏≤‡∏ó</h3></div>
        </div>

        <div class="bg-dynamic-med p-4 rounded-lg shadow-lg mt-4">
            <h3 class="text-xl font-semibold mb-3">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≠‡∏ö <span id="table-period-label"></span></h3>
            <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr class="border-b border-dynamic"><th class="p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-2">‡∏Å‡∏∞</th><th class="p-2">‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</th><th class="p-2">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</th><th class="p-2">‡∏£‡∏ß‡∏°</th></tr></thead><tbody id="details-table-body"></tbody></table></div>
        </div>
        
        <div class="bg-dynamic-med p-4 rounded-lg shadow-lg mt-4 text-center">
             <h3 class="text-xl font-semibold mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
             <div class="flex flex-wrap justify-center gap-4">
                <button id="print-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏™‡∏£‡∏∏‡∏õ</button>
                <button id="pdf-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF</button>
                <button id="backup-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button id="import-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="page hidden max-w-4xl mx-auto">
        <div class="flex items-center mb-6">
            <button id="back-to-main-btn" class="mr-4 p-2 rounded-full hover:bg-dynamic-light">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <h1 class="text-2xl md:text-3xl font-bold text-blue-400">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h1>
        </div>
        <div class="bg-dynamic-med p-4 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏á‡∏≤‡∏ô</h2>
            <div class="bg-dynamic-light p-4 rounded-lg mb-4">
                <h3 class="font-semibold mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="new-trip-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô Express)" class="flex-grow border rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                    <input type="number" id="new-trip-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-full sm:w-24 border rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                    <button id="add-trip-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</h3>
                <div id="custom-trips-list" class="space-y-2"></div>
            </div>
        </div>
    </div>
    
    <div id="delete-modal" class="modal"><div class="modal-content bg-dynamic-med text-center"><h4 class="text-lg font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h4><p class="mb-6">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="delete-modal-date" class="font-bold text-yellow-400"></span>?</p><div class="flex justify-center gap-4"><button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg w-24">‡∏•‡∏ö</button><button id="cancel-delete-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg w-24">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div></div>
    <div id="print-section" class="hidden"></div>
    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { jsPDF } = window.jspdf;

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAoMrrWGRmd9PuyYtGkK7ZQUDZWdgaoYaE",
            authDomain: "daily-wage-tracking.firebaseapp.com",
            projectId: "daily-wage-tracking",
            storageBucket: "daily-wage-tracking.appspot.com",
            messagingSenderId: "147445421202",
            appId: "1:147445421202:web:b9b078e749d8fc09b0424b"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State & Elements ---
        let userId = null, records = {}, settings = { customTrips: {} };
        let unsubscribeRecords, unsubscribeSettings;
        let currentDate = new Date(), currentYear = currentDate.getFullYear(), currentMonth = currentDate.getMonth();
        let selectedDate = currentDate.toISOString().split('T')[0];
        
        const syncIndicator = document.getElementById('sync-indicator');
        const mainPage = document.getElementById('main-page');
        const settingsPage = document.getElementById('settings-page');
        const settingsBtn = document.getElementById('settings-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const toastEl = document.getElementById('toast');
        const calendarBodyEl = document.getElementById('calendar-body');
        const monthYearEl = document.getElementById('month-year');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const tripCountersContainer = document.getElementById('trip-counters-container');
        const dailyTotalEl = document.getElementById('daily-total');
        const formElements = {
            shiftDay: document.getElementById('shift-day'), shiftNight: document.getElementById('shift-night'),
            otBefore: document.getElementById('ot-before'), otherTrips: document.getElementById('other-trips'),
            otherTripsDetails: document.getElementById('other-trips-details'), otAfter: document.getElementById('ot-after'),
            specialFood: document.getElementById('special-food'), allowance: document.getElementById('allowance'),
        };

        // --- Theme Logic ---
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            if (theme === 'dark') {
                sunIcon.classList.add('hidden'); moonIcon.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden'); moonIcon.classList.add('hidden');
            }
            localStorage.setItem('wage-app-theme', theme);
        }

        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });

        // --- Core Functions (Toast, Sync, Navigation) ---
        function showToast(message, type = 'info', duration = 3000) {
            toastEl.textContent = message;
            toastEl.className = ``;
            toastEl.classList.add('show', type);
            setTimeout(() => { toastEl.classList.remove('show'); }, duration);
        }
        function showSync() { syncIndicator.style.display = 'block'; }
        function hideSync() { syncIndicator.style.display = 'none'; }
        function navigateTo(page) {
            mainPage.classList.toggle('hidden', page !== 'main');
            settingsPage.classList.toggle('hidden', page !== 'settings');
        }
        settingsBtn.addEventListener('click', () => navigateTo('settings'));
        backToMainBtn.addEventListener('click', () => navigateTo('main'));

        // --- Authentication & Data Fetching ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                if (unsubscribeRecords) unsubscribeRecords();
                if (unsubscribeSettings) unsubscribeSettings();
                listenToData();
            } else {
                signInAnonymously(auth).catch(err => console.error(err));
            }
        });

        function listenToData() {
            if (!userId) return;
            showSync();
            unsubscribeRecords = onSnapshot(collection(db, `users/${userId}/records`), snapshot => {
                records = {};
                snapshot.forEach(doc => { records[doc.id] = doc.data(); });
                renderCalendar(currentYear, currentMonth);
                updateSummaryAndTable();
                loadRecordForDate(selectedDate);
                hideSync();
            }, err => { console.error(err); hideSync(); });
            unsubscribeSettings = onSnapshot(doc(db, `users/${userId}/settings/main`), docSnap => {
                settings = docSnap.exists() ? docSnap.data() : { customTrips: {} };
                renderAllTripInputs();
                renderCustomTripsList();
            }, err => console.error(err));
        }

        // --- Settings Page ---
        const newTripNameEl = document.getElementById('new-trip-name');
        const newTripPriceEl = document.getElementById('new-trip-price');
        const addTripBtn = document.getElementById('add-trip-btn');
        const customTripsListEl = document.getElementById('custom-trips-list');

        async function saveSettings() {
            if (!userId) return;
            showSync();
            try {
                await setDoc(doc(db, `users/${userId}/settings/main`), settings);
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (e) { console.error(e); } 
            finally { hideSync(); }
        }

        addTripBtn.addEventListener('click', () => {
            const name = newTripNameEl.value.trim();
            const price = parseFloat(newTripPriceEl.value);
            if (name && price >= 0) {
                if (!settings.customTrips) settings.customTrips = {};
                settings.customTrips[`custom_${Date.now()}`] = { name, price };
                saveSettings();
                newTripNameEl.value = ''; newTripPriceEl.value = '';
            } else { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
        });

        customTripsListEl.addEventListener('click', e => {
            const deleteButton = e.target.closest('.delete-trip-btn');
            if (deleteButton) {
                delete settings.customTrips[deleteButton.dataset.id];
                saveSettings();
            }
        });

        function renderCustomTripsList() {
            customTripsListEl.innerHTML = '';
            const tripIds = settings.customTrips ? Object.keys(settings.customTrips) : [];
            if (tripIds.length === 0) {
                customTripsListEl.innerHTML = `<p class="text-dynamic-secondary">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á...</p>`; return;
            }
            tripIds.forEach(id => {
                const trip = settings.customTrips[id];
                customTripsListEl.innerHTML += `<div class="flex justify-between items-center bg-dynamic-light p-2 rounded-md"><span>${trip.name} (${trip.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó)</span><button data-id="${id}" class="delete-trip-btn text-red-400 hover:text-red-600 p-1 text-2xl font-bold">&times;</button></div>`;
            });
        }

        // --- Main Page: Dynamic Inputs ---
        const defaultTrips = {
            sht: { label: "SHT (20/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß, 10/‡∏Ñ‡∏£‡∏∂‡πà‡∏á)", step: 0.5 }, a1pl: { label: "A1 P/L (60/80/180)", step: 1 },
            gw: { label: "G/W (180/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß)", step: 1 }, kd: { label: "KD (180/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß)", step: 1 },
            tru: { label: "TRU (140/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß)", step: 1 }, dmet: { label: "DMET (140/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß)", step: 1 }
        };

        function createTripInputElement(id, label, step) {
            return `<div class="flex justify-between items-center"><label>${label}</label><div class="input-number-control"><button data-field="${id}" data-step="-${step}">-</button><input type="number" id="${id}" step="${step}" class="w-16" placeholder=""><button data-field="${id}" data-step="${step}">+</button></div></div>`;
        }

        function renderAllTripInputs() {
            let html = '';
            Object.keys(defaultTrips).forEach(id => {
                html += createTripInputElement(id, defaultTrips[id].label, defaultTrips[id].step);
            });
            if (settings.customTrips) {
                Object.keys(settings.customTrips).forEach(id => {
                    const trip = settings.customTrips[id];
                    html += createTripInputElement(id, `${trip.name} (${trip.price}/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß)`, 1);
                });
            }
            tripCountersContainer.innerHTML = html;
        }
        
        // --- Calendar Logic ---
        function renderCalendar(year, month) {
            calendarBodyEl.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            monthYearEl.textContent = `${new Date(year, month).toLocaleString('th-TH', { month: 'long' })} ${year + 543}`;
            for (let i = 0; i < firstDay; i++) { calendarBodyEl.innerHTML += '<div></div>'; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayEl.textContent = day;
                dayEl.className = 'calendar-day';
                dayEl.dataset.date = dateStr;
                const todayStr = new Date().toISOString().split('T')[0];
                if (dateStr === todayStr) dayEl.classList.add('today');
                if (dateStr === selectedDate) dayEl.classList.add('selected');
                if (records[dateStr] && records[dateStr].total > 0) {
                    dayEl.classList.add('has-data');
                    const shiftIcon = document.createElement('span');
                    shiftIcon.className = 'shift-icon';
                    if (records[dateStr].shift === 'day') shiftIcon.textContent = '‚òÄÔ∏è';
                    else if (records[dateStr].shift === 'night') shiftIcon.textContent = 'üåô';
                    else if (records[dateStr].shift === 'both') shiftIcon.textContent = '‚òÄÔ∏èüåô';
                    dayEl.appendChild(shiftIcon);
                }
                dayEl.addEventListener('click', () => {
                    selectedDate = dateStr;
                    document.querySelector('.calendar-day.selected')?.classList.remove('selected');
                    dayEl.classList.add('selected');
                    updateSelectedDateDisplay();
                    loadRecordForDate(dateStr);
                });
                calendarBodyEl.appendChild(dayEl);
            }
        }
        document.getElementById('prev-month').addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(currentYear, currentMonth); });
        document.getElementById('next-month').addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(currentYear, currentMonth); });

        // --- Form & Calculation Logic ---
        function calculateTotal() {
            let total = 0;
            const FIXED_WAGE = 372, FIXED_TRAVEL = 60, FIXED_FOOD = 50, NIGHT_SHIFT_BONUS = 100;
            if (formElements.shiftDay.checked || formElements.shiftNight.checked) { total += FIXED_WAGE + FIXED_TRAVEL + FIXED_FOOD; }
            if (formElements.shiftNight.checked) { total += NIGHT_SHIFT_BONUS; }
            
            Object.keys(defaultTrips).forEach(id => {
                const input = document.getElementById(id);
                if (!input) return;
                const val = parseFloat(input.value) || 0;
                if (id === 'sht') total += val * 20;
                else if (id === 'a1pl') {
                    if (val === 1) total += 60; else if (val === 2) total += 140; else if (val >= 3) total += 320 + (val - 3) * 180;
                }
                else if (id === 'gw' || id === 'kd') total += val * 180;
                else if (id === 'tru' || id === 'dmet') total += val * 140;
            });

            if (settings.customTrips) {
                Object.keys(settings.customTrips).forEach(id => {
                    const trip = settings.customTrips[id];
                    const count = parseInt(document.getElementById(id)?.value) || 0;
                    total += count * trip.price;
                });
            }

            total += parseFloat(formElements.otBefore.value) || 0;
            total += parseFloat(formElements.otherTrips.value) || 0;
            total += parseFloat(formElements.otAfter.value) || 0;
            total += parseFloat(formElements.specialFood.value) || 0;
            total += parseFloat(formElements.allowance.value) || 0;
            dailyTotalEl.textContent = total.toLocaleString();
            return total;
        }
        document.getElementById('main-page').addEventListener('input', calculateTotal);
        document.getElementById('main-page').addEventListener('click', e => {
            const button = e.target.closest('.input-number-control button');
            if (button) {
                const field = button.dataset.field;
                const step = parseFloat(button.dataset.step);
                const input = document.getElementById(field);
                if(input) {
                    let newValue = (parseFloat(input.value) || 0) + step;
                    if (newValue < 0) newValue = 0;
                    input.value = newValue;
                    calculateTotal();
                }
            }
        });

        // --- Data Handling (Save, Load, Clear, Delete) ---
        function clearForm() {
            document.querySelectorAll('#main-page input, #main-page textarea').forEach(el => {
                if (el.type === 'checkbox') el.checked = false;
                else if (el.type !== 'file') el.value = '';
            });
            calculateTotal();
        }

        function updateSelectedDateDisplay() {
             selectedDateDisplay.textContent = new Date(selectedDate).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        }
        
        function loadRecordForDate(dateStr) {
            clearForm();
            const data = records[dateStr];
            if (data) {
                formElements.shiftDay.checked = data.shift === 'day' || data.shift === 'both';
                formElements.shiftNight.checked = data.shift === 'night' || data.shift === 'both';
                
                const allTrips = {...(data.trips || {}), ...(data.customTrips || {})};
                Object.keys(allTrips).forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.value = allTrips[id] || '';
                });

                Object.keys(formElements).forEach(key => {
                    if(data[key] && key !== 'shiftDay' && key !== 'shiftNight') formElements[key].value = data[key] || '';
                });
            }
            calculateTotal();
        }

        async function saveRecord() {
            if (!userId) { showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...", 'error'); return; }
            const total = calculateTotal();
            if (total === 0 && !formElements.shiftDay.checked && !formElements.shiftNight.checked) { showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", 'error'); return; }
            let shift = '';
            if (formElements.shiftDay.checked && formElements.shiftNight.checked) shift = 'both';
            else if (formElements.shiftDay.checked) shift = 'day';
            else if (formElements.shiftNight.checked) shift = 'night';
            
            const tripsData = {}, customTripsData = {};
            document.querySelectorAll('#trip-counters-container input').forEach(input => {
                const id = input.id;
                const value = id === 'sht' ? parseFloat(input.value) || 0 : parseInt(input.value) || 0;
                if (id.startsWith('custom_')) customTripsData[id] = value;
                else tripsData[id] = value;
            });

            const data = {
                date: selectedDate, shift, total, trips: tripsData, customTrips: customTripsData,
                otBefore: parseFloat(formElements.otBefore.value) || 0, otherTrips: parseFloat(formElements.otherTrips.value) || 0,
                otherTripsDetails: formElements.otherTripsDetails.value || '', otAfter: parseFloat(formElements.otAfter.value) || 0,
                specialFood: parseFloat(formElements.specialFood.value) || 0, allowance: parseFloat(formElements.allowance.value) || 0,
            };
            
            showSync();
            try {
                await setDoc(doc(db, `users/${userId}/records`, selectedDate), data);
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                clearForm();
            } catch (e) {
                console.error(e); showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            } finally { hideSync(); }
        }
        
        async function deleteRecord() { /* ... full implementation ... */ }
        
        // --- Summary & Table Logic ---
        function updateSummaryAndTable() { /* ... full implementation ... */ }
        document.getElementById('period-selector').addEventListener('change', updateSummaryAndTable);

        // --- Modal Logic ---
        const deleteModal = document.getElementById('delete-modal');
        function openDeleteModal() {
            if (!records[selectedDate]) { showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏ö", 'error'); return; }
            document.getElementById('delete-modal-date').textContent = new Date(selectedDate).toLocaleDateString('th-TH');
            deleteModal.style.display = 'flex';
        }
        function closeDeleteModal() { deleteModal.style.display = 'none'; }
        document.getElementById('delete-btn').addEventListener('click', openDeleteModal);
        document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteModal);
        document.getElementById('confirm-delete-btn').addEventListener('click', deleteRecord);
        
        // --- Data Import/Export/Print/PDF ---
        document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
        document.getElementById('import-file-input').addEventListener('change', handleFileImport);
        function handleFileImport(event) { /* ... full implementation ... */ }
        document.getElementById('backup-btn').addEventListener('click', () => { /* ... backup logic ... */ });
        document.getElementById('print-btn').addEventListener('click', () => { /* ... print logic ... */ });
        document.getElementById('pdf-btn').addEventListener('click', async () => { /* ... pdf logic from above ... */ });

        // --- Event Listeners & Initial Load ---
        document.getElementById('save-btn').addEventListener('click', saveRecord);
        document.getElementById('clear-btn').addEventListener('click', clearForm);
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('wage-app-theme') || 'dark';
            applyTheme(savedTheme);
            const day = new Date().getDate();
            document.getElementById('period-selector').value = (day > 15) ? '16-end' : '1-15';
            updateSelectedDateDisplay();
            renderCalendar(currentYear, currentMonth);
            navigateTo('main');
        });
    </script>
</body>
</html>