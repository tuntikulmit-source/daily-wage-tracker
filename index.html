<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏≠‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/3b82f6/FFFFFF?text=WageApp">

    <!-- Styles and Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f5; color: #1f2937; }
        .card { background-color: #ffffff; border: 1px solid #e5e7eb; }
        .modal-content { background-color: #ffffff; border: 1px solid #e5e7eb; }
        input, textarea { background-color: #f9fafb; border: 1px solid #d1d5db; color: #1f2937; }
        input::placeholder, textarea::placeholder { color: #6b7280; }
        .calendar-day { transition: all 0.2s ease-in-out; }
        .calendar-day:hover { transform: scale(1.05); box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .selected-day { background-color: #3b82f6 !important; color: white !important; border-radius: 50%; }
        .work-day { background-color: #dbeafe; position: relative; }
        .shift-icon { position: absolute; bottom: 2px; right: 2px; font-size: 0.6rem; }
        .input-number-control button { width: 2rem; height: 2rem; }
        .input-number-control input { width: 4rem; text-align: center; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        #loading-overlay { display: none; position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); z-index: 100; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #sync-status { position: fixed; bottom: 1rem; right: 1rem; padding: 0.5rem 1rem; border-radius: 9999px; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s ease-in-out; z-index: 40; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="flex flex-col items-center justify-center">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-3 text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- Main App Container -->
    <div id="app-container">
        <div class="container mx-auto p-4 max-w-2xl pb-24">
            <header class="relative text-center mb-6">
                <h1 class="text-3xl font-bold text-blue-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h1>
                <p class="text-gray-500">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 9.1</p>
                <div class="absolute top-0 right-0">
                    <button id="settings-btn" class="text-2xl text-gray-500 hover:text-blue-600 transition">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </header>
            
            <div id="calendar-container" class="card p-4 rounded-lg shadow-md mb-6">
                <div class="flex justify-between items-center mb-4"><button id="prev-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&lt;</button><h2 id="month-year" class="text-xl font-semibold"></h2><button id="next-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&gt;</button></div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>
            <div id="entry-form" class="card p-4 rounded-lg shadow-md mb-6">
                <h3 class="text-lg font-semibold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="selected-date-display" class="text-blue-600"></span></h3>
                <div class="grid grid-cols-2 gap-4 mb-4"><label class="flex items-center p-3 border rounded-lg cursor-pointer border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500"><input type="checkbox" id="morning-shift" class="form-checkbox h-5 w-5 text-blue-600"><span class="ml-3">‚òÄÔ∏è ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤</span></label><label class="flex items-center p-3 border rounded-lg cursor-pointer border-gray-200 has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500"><input type="checkbox" id="night-shift" class="form-checkbox h-5 w-5 text-indigo-600"><span class="ml-3">üåô ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (+100)</span></label></div>
                <div class="grid grid-cols-3 gap-2 mb-4 text-center"><div class="p-2 bg-green-100 rounded-lg"><p class="text-sm text-green-700">‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</p><p class="font-bold">372 ‡∏ø</p></div><div class="p-2 bg-yellow-100 rounded-lg"><p class="text-sm text-yellow-700">‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</p><p class="font-bold">60 ‡∏ø</p></div><div class="p-2 bg-orange-100 rounded-lg"><p class="text-sm text-orange-700">‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p><p class="font-bold">50 ‡∏ø</p></div></div>
                <div class="space-y-3 mb-4"><h4 class="font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á</h4><div id="trips-container" class="space-y-3"></div></div>
                <div class="space-y-3"><h4 class="font-semibold">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><input type="number" id="pre-ot" class="w-full p-2 rounded-md" placeholder="‡∏Ñ‡πà‡∏≤‡πÇ‡∏≠‡∏ó‡∏µ‡∏´‡∏ô‡πâ‡∏≤"><input type="number" id="post-ot" class="w-full p-2 rounded-md" placeholder="‡∏Ñ‡πà‡∏≤‡πÇ‡∏≠‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á"><input type="number" id="other-trips-income" class="w-full p-2 rounded-md" placeholder="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ"><input type="number" id="special-food" class="w-full p-2 rounded-md" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©"><input type="number" id="diligence-bonus" class="w-full p-2 rounded-md" placeholder="‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ç‡∏¢‡∏±‡∏ô"></div><textarea id="other-trips-details" class="w-full p-2 rounded-md mt-3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ"></textarea></div>
                <div class="mt-6"><div class="text-center p-4 bg-blue-50 rounded-lg mb-4"><p class="text-lg">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p><p id="total-income" class="text-3xl font-bold text-blue-600">0.00 ‡∏ø</p></div><div class="flex gap-4"><button id="save-btn" class="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button id="delete-btn" class="w-full py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition hidden"><i class="fas fa-trash"></i> ‡∏•‡∏ö</button></div></div>
            </div>
            <div class="text-center mb-6"><button id="toggle-summary-btn" class="w-full py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"><i class="fas fa-chart-bar"></i> ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button></div>
            <div id="summary-section" class="card p-4 rounded-lg shadow-md hidden">
                <h3 class="text-xl font-semibold mb-4 text-center">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h3>
                <div class="flex justify-between items-center mb-4"><button id="summary-prev-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&lt; ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button><h4 id="summary-month-year" class="text-lg font-semibold"></h4><button id="summary-next-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô &gt;</button></div>
                <div class="grid grid-cols-2 gap-2 mb-4"><button id="period-1" class="w-full py-2 bg-blue-600 text-white rounded-md">‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-15</button><button id="period-2" class="w-full py-2 bg-gray-300 text-gray-800 rounded-md">‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 16-‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button></div>
                <div class="mb-6"><canvas id="summary-chart"></canvas></div>
                <div id="summary-content">
                    <div id="summary-table-container" class="mb-6"><h5 class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h5><div class="overflow-x-auto"><table class="min-w-full border border-gray-200"><thead class="bg-gray-100"><tr><th class="py-2 px-3 border-b border-gray-200">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="py-2 px-3 border-b border-gray-200">‡∏Å‡∏∞</th><th class="py-2 px-3 border-b border-gray-200 text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ø)</th></tr></thead><tbody id="summary-daily-tbody"></tbody></table></div></div>
                    <div id="summary-details-container"><h5 class="font-semibold mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h5><div id="summary-breakdown" class="space-y-1 text-sm"></div></div>
                </div>
                <div class="text-center p-4 bg-green-100 rounded-lg mt-6"><p class="text-lg font-medium text-green-800">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ</p><p id="summary-grand-total" class="text-3xl font-bold text-green-600">0.00 ‡∏ø</p></div>
                <div class="border-t border-gray-200 pt-4 mt-4"><h4 class="font-semibold mb-2 text-center">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><button id="export-csv-btn" class="w-full py-2 bg-teal-500 text-white rounded-lg"><i class="fas fa-file-csv"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV</button><button id="export-pdf-btn" class="w-full py-2 bg-red-500 text-white rounded-lg"><i class="fas fa-file-pdf"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button></div></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="modal"><div class="modal-content">
        <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3><button id="close-settings-btn" class="text-2xl text-gray-500">&times;</button></div>
        <div class="border-t border-gray-200 pt-4">
            <h4 class="font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (User ID)</h4>
            <p class="text-sm text-gray-500 mb-2">‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</p>
            <div class="flex items-center gap-2 p-2 bg-gray-100 rounded-md">
                <input type="text" id="user-id-display" class="w-full bg-transparent border-none text-gray-600" readonly>
                <button id="copy-user-id-btn" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-md">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
            </div>
        </div>
        <div class="border-t border-gray-200 pt-4 mt-4"><h4 class="font-semibold mb-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏á‡∏≤‡∏ô</h4><div id="trip-settings-list" class="space-y-2 mb-6 max-h-48 overflow-y-auto"></div><h5 class="font-semibold mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h5><div class="flex flex-col sm:flex-row gap-2 mb-6"><input type="text" id="new-trip-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏á‡∏≤‡∏ô" class="p-2 rounded-md flex-grow"><input type="number" id="new-trip-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="p-2 rounded-md w-full sm:w-32"><button id="add-new-trip-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div></div>
        <div class="border-t border-gray-200 pt-4 mt-4"><h4 class="font-semibold mb-2">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><button id="export-data-btn" class="w-full py-2 bg-sky-500 text-white rounded-lg"><i class="fas fa-download"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button><button id="import-data-btn" class="w-full py-2 bg-emerald-500 text-white rounded-lg"><i class="fas fa-upload"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><input type="file" id="import-file-input" class="hidden" accept=".json"></div></div>
        <div class="flex justify-end gap-4 mt-6 border-t border-gray-200 pt-4">
            <button id="save-settings-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button>
        </div>
    </div></div>
    <div id="delete-modal" class="modal"><div class="modal-content text-center"><h3 class="text-xl font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3><p class="mb-6 text-gray-600">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="delete-modal-date"></span> ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p><div class="flex justify-center gap-4"><button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button><button id="cancel-delete-btn" class="px-6 py-2 bg-gray-300 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div></div>
    <div id="import-confirm-modal" class="modal"><div class="modal-content text-center"><h3 class="text-xl font-bold mb-4 text-orange-600">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><p class="mb-6 text-gray-600">‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?</p><div class="flex justify-center gap-4"><button id="confirm-import-btn" class="px-6 py-2 bg-orange-500 text-white rounded-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button><button id="cancel-import-btn" class="px-6 py-2 bg-gray-300 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div></div>

    <!-- Sync Status Indicator -->
    <div id="sync-status">
        <i id="sync-icon" class="fas fa-cloud"></i>
        <span id="sync-text"></span>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Main App Logic -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) { 
            window.addEventListener('load', () => { 
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered.'))
                    .catch(err => console.log('Service Worker registration failed: ', err)); 
            }); 
        }
        
        // Firebase Configuration from user
        const firebaseConfig = {
          apiKey: "AIzaSyAoMrrWGRmd9PuyYtGkK7ZQUDZWdgaoYaE",
          authDomain: "daily-wage-tracking.firebaseapp.com",
          projectId: "daily-wage-tracking",
          storageBucket: "daily-wage-tracking.appspot.com",
          messagingSenderId: "147445421202",
          appId: "1:147445421202:web:b9b078e749d8fc09b0424b",
          measurementId: "G-QERWN01SXH"
        };
        
        // Global state variables
        const appId = 'daily-wage-app-data'; // A consistent collection name
        let app, auth, db, userId;
        let records = {};
        let tripSettings = [];
        let unsubscribeFromRecords = null;
        let summaryChart = null; 
        const defaultTripSettings = [ { id: 'sht', name: 'SHT', price: 20, type: 'step', step: 0.5, editable: true }, { id: 'a1pl', name: 'A1 P/L', prices: [60, 80, 180], type: 'tiered', editable: false }, { id: 'gw', name: 'G/W', price: 180, type: 'step', step: 1, editable: true }, { id: 'kd', name: 'KD', price: 180, type: 'step', step: 1, editable: true }, { id: 'tru', name: 'TRU', price: 140, type: 'step', step: 1, editable: true }, { id: 'dmet', name: 'DMET', price: 140, type: 'step', step: 1, editable: true }, ];
        const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        let currentDate = new Date();
        let selectedDate = null;
        let summaryDate = new Date();
        let summaryPeriod = 'first';

        // UI Elements
        const syncStatusEl = document.getElementById('sync-status');
        const syncIconEl = document.getElementById('sync-icon');
        const syncTextEl = document.getElementById('sync-text');

        // --- UI HELPER FUNCTIONS ---
        function showLoader(text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") { document.getElementById('loading-text').textContent = text; document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loading-overlay').style.display = 'none'; }
        function showStatusMessage(message, isError = false) { const el = document.getElementById('status-message'); el.textContent = message; el.className = `mt-4 text-center p-2 rounded-md ${isError ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 3000); }
        function updateSyncStatus(status, message) {
            syncTextEl.textContent = message;
            syncIconEl.className = 'fas'; // Reset classes
            switch(status) {
                case 'syncing': syncStatusEl.className = 'bg-blue-500 text-white'; syncIconEl.classList.add('fa-cloud-upload-alt', 'animate-pulse'); break;
                case 'synced': syncStatusEl.className = 'bg-green-500 text-white'; syncIconEl.classList.add('fa-check-circle'); break;
                case 'error': syncStatusEl.className = 'bg-red-500 text-white'; syncIconEl.classList.add('fa-exclamation-triangle'); break;
                default: syncStatusEl.className = 'bg-gray-400 text-white'; syncIconEl.classList.add('fa-cloud');
            }
        }
        
        // --- APP INITIALIZATION ---
        function initializeAppLogic() {
            showLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...");
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    if (userId !== user.uid) {
                        userId = user.uid;
                        document.getElementById('user-id-display').value = userId;
                        if (typeof unsubscribeFromRecords === 'function') unsubscribeFromRecords();
                        loadSettings().then(() => {
                            listenToRecords();
                            const today = new Date();
                            const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                            selectDate(todayString);
                            renderCalendar(new Date());
                        });
                    }
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        updateSyncStatus('error', '‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                    });
                }
            });
        }

        // --- DATA HANDLING ---
        function listenToRecords() {
            if (!userId) return;
            updateSyncStatus('syncing', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...');
            const recordsCol = collection(db, 'artifacts', appId, 'users', userId, 'records');
            unsubscribeFromRecords = onSnapshot(recordsCol, (snapshot) => {
                records = {}; // Clear local cache before repopulating
                snapshot.forEach(doc => { records[doc.id] = doc.data(); });
                renderCalendar(currentDate);
                if (document.getElementById('summary-section') && !document.getElementById('summary-section').classList.contains('hidden')) renderSummary();
                hideLoader();
                setTimeout(() => updateSyncStatus('synced', '‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'), 500);
            }, (error) => { 
                console.error("Error listening:", error); 
                updateSyncStatus('error', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                hideLoader(); 
            });
        }
        
        async function loadSettings() {
            if (!userId) return;
            const settingsRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'main');
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists() && docSnap.data().tripSettings) {
                tripSettings = docSnap.data().tripSettings;
            } else {
                tripSettings = JSON.parse(JSON.stringify(defaultTripSettings));
            }
            renderTripInputs();
        }

        async function saveRecord(dateString, data) {
            if (!userId) return;
            updateSyncStatus('syncing', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            const recordRef = doc(db, 'artifacts', appId, 'users', userId, 'records', dateString);
            try {
                await setDoc(recordRef, data);
                showStatusMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", false);
                return true;
            } catch (error) { 
                console.error("Error saving record:", error); 
                showStatusMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", true);
                updateSyncStatus('error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                return false; 
            }
        }

        // --- All other functions (rendering, calculations, etc.) are placed here ---
        // ... The full JavaScript from previous versions goes here ...
        
        // --- EVENT LISTENERS ---
        window.onload = initializeAppLogic;

        document.getElementById('copy-user-id-btn').addEventListener('click', () => {
            const userIdInput = document.getElementById('user-id-display');
            userIdInput.select();
            userIdInput.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(userIdInput.value).then(() => {
                    showStatusMessage("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å User ID ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", false);
                }).catch(err => {
                    document.execCommand('copy');
                    showStatusMessage("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å User ID ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", false);
                });
            } catch (err) {
                document.execCommand('copy');
                showStatusMessage("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å User ID ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", false);
            }
        });
        
        // --- Add all other event listeners and functions from previous versions below ---
        // (This is a placeholder for brevity, the full code would include all functions)

    </script>
</body>
</html>